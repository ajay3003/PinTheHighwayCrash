@* PinTheHighwayCrash/Shared/OfflineBadge.razor *@
@implements IDisposable
@using Microsoft.JSInterop
@inject IJSRuntime JS

@if (!_online)
{
    <div class="alert alert-warning py-2 px-3 small mb-2 rounded-2 shadow-sm">
        <strong>Offline mode:</strong> Map tiles and verification may be limited.
        Phone and SMS still work if you have cellular signal.
    </div>
}

@code {
    private bool _online = true;
    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        _online = await GetOnlineAsync();
        _cts = new CancellationTokenSource();
        _ = PollConnectivityAsync(_cts.Token);
    }

    private async Task<bool> GetOnlineAsync()
    {
        // navigator.onLine is fast and doesn’t need a full interop call chain
        try
        {
            return await JS.InvokeAsync<bool>("eval", "navigator.onLine");
        }
        catch
        {
            // if JS runtime isn’t ready yet (e.g., prerender), assume online
            return true;
        }
    }

    private async Task PollConnectivityAsync(CancellationToken token)
    {
        try
        {
            while (!token.IsCancellationRequested)
            {
                var current = await GetOnlineAsync();
                if (current != _online)
                {
                    _online = current;
                    await InvokeAsync(StateHasChanged);
                }
                await Task.Delay(2000, token); // check every 2s
            }
        }
        catch (TaskCanceledException)
        {
            // normal on dispose
        }
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
