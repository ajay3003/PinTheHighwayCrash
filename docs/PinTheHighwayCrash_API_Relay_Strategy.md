# 📡 PinTheHighwayCrash — API Relay Extension Strategy

## 🔍 Overview

This document explains how to **extend the current client-only emergency contact system** in *PinTheHighwayCrash* to support **server-based message relays** that do not depend on users having WhatsApp installed.

> ⚙️ This is an **optional enhancement**, *in addition to* the current WhatsApp deep-link mechanism already implemented in the app.

---

## 💬 Current Behavior (Client-Only)

The app currently sends emergency alerts via system-handled links:

| Channel | Mechanism | Requires App | Works Offline | Notes |
|----------|------------|---------------|----------------|-------|
| 📞 Call | `tel:` link | No | ✅ Yes (cell network) | Opens phone dialer |
| 💬 SMS | `sms:` link | No | ✅ Yes (cell network) | Opens native SMS app |
| 📧 Email | `mailto:` link | Yes | ⚠️ Needs internet | Opens default mail client |
| 💬 WhatsApp | `https://wa.me/` link | ✅ Yes | ⚠️ Needs data | Opens WhatsApp app or WhatsApp Web |

This ensures full operation **without any backend**, using only device capabilities.

---

## 🚀 Optional Server Relay Extension

To reach users or authorities **without requiring WhatsApp or manual messaging**, a backend relay API can be added.

### 1️⃣ Purpose

Allow the app to **send the same emergency payload** via:
- Server-side **SMS**, **Email**, or **WhatsApp Business Cloud API**
- Optionally, **Voice bridge calls**

### 2️⃣ How It Works

```
User → PWA → /api/report → Server Relay → Recipient (Police/Hospital)
```

- The PWA collects GPS coordinates, message text, and nearest contact info.  
- Sends a JSON payload to your API (`/api/report`).
- The API distributes the message via one or more channels (SMS, Email, WhatsApp Cloud, etc.).

---

## 📡 Integration Design

### ✅ Minimal payload example

```json
POST /api/report
{
  "timestampUtc": "2025-10-27T09:12:00Z",
  "pin": { "lat": 12.34, "lng": 56.78 },
  "reporter": { "lat": 12.33, "lng": 56.79, "accuracyM": 18 },
  "message": "EMERGENCY: Highway accident reported near coordinates.",
  "contacts": {
    "police": [{ "name": "Nearest PS", "phone": "+91..." }],
    "hospital": [{ "name": "XYZ Hospital", "phone": "+91...", "address": "..." }]
  },
  "channels": { "sms": true, "email": true, "whatsapp": true }
}
```

---

## ⚙️ Provider Options

| Channel | Provider | Internet Needed | India Regulatory Status |
|----------|-----------|------------------|--------------------------|
| **SMS** | MSG91, Textlocal, Karix | ✅ Yes (server) | Requires DLT registration |
| **Email** | SendGrid, SES, SMTP | ✅ Yes | No DLT, just DKIM/SPF |
| **WhatsApp Business API** | Meta Cloud API | ✅ Yes | Requires business verification, approved templates |
| **Voice Bridge** | Twilio, Exotel | ✅ Yes | Cannot call 112; use local station lines |

---

## 🇮🇳 India-Specific Notes

- **DLT (TRAI)** required for all A2P (server-to-person) SMS.  
  Register templates and sender ID (Header).  
- **WhatsApp Cloud API** requires verified business and opt-in flow.  
- **Emergency number (112)** cannot be programmatically dialed; only direct `tel:` link works on the device.

---

## 🧭 Recommended Hybrid Architecture

| Scenario | Preferred Channel | Fallback |
|-----------|------------------|-----------|
| User has phone signal but no data | SMS via device | `tel:` |
| User has data but no WhatsApp installed | Server SMS/Email | `sms:` |
| User has WhatsApp | `wa.me` deep link | Server relay |
| User is offline | Device `sms:` or `tel:` | Queue locally, retry later |

---

## 🧩 How It Extends the Current System

This API extension **adds more reliability** but **does not replace** the existing client-side flow.

- ✅ Works seamlessly with the same `EmergencyOptions` structure.  
- ✅ Can be toggled with config flag: `IntegrationApi.Enabled = true`.  
- ✅ Reuses the same message text and contact data generated by the PWA.  
- ✅ Allows future integration with hospital/police APIs for automatic routing.

---

## ⚖️ Decision Matrix

| Channel | Needs App? | Works Offline? | Best Use Case |
|----------|-------------|----------------|----------------|
| Client `tel:` | No | ✅ Yes | Emergency voice call |
| Client `sms:` | No | ✅ Yes | Cellular SMS |
| Server SMS | No | ❌ | Data connection but no user action |
| Server Email | No | ❌ | Notify multiple agencies |
| WA Cloud API | No | ❌ | Send structured WhatsApp alerts |
| Voice Bridge | No | ❌ | Connect both parties via server call |

---

## 📦 Summary

This strategy provides:
- A **hybrid model** combining **client-only offline flows** and **server-assisted online relays**.
- Backward-compatible design — no breaking changes to existing app logic.
- Compliance-ready structure for India and scalable to global APIs.

> In short: WhatsApp deep links keep working as before, while the API relay adds automation, reliability, and flexibility for future scaling.
